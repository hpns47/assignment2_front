console.log("script.js loaded");

const qs = (sel, root = document) => root.querySelector(sel);
const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));
const on = (el, ev, fn, opts) => el && el.addEventListener(ev, fn, opts);

document.addEventListener("DOMContentLoaded", () => {
  initGlobal();

  // –†–æ—É—Ç–∏–Ω–≥ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  const page = document.body.dataset.page;
  switch (page) {
    case "index":
      initIndexPage();
      break;

    default:
      // –Ω–∏—á–µ–≥–æ
      break;
  }
});

function initGlobal() {
  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é
  const nav = qs("#mainNav");
  if (nav) {
    on(nav, "keydown", (e) => {
      const links = qsa(".nav-link", nav);
      if (!links.length) return;
      const idx = links.indexOf(document.activeElement);

      // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–æ–∫—É—Å —É–∂–µ –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ –ø—É–Ω–∫—Ç–æ–≤
      if (idx === -1) return;

      let next = idx;
      switch (e.key) {
        case "ArrowRight":
          next = (idx + 1) % links.length;
          e.preventDefault();
          break;
        case "ArrowLeft":
          next = (idx - 1 + links.length) % links.length;
          e.preventDefault();
          break;
        case "Home":
          next = 0;
          e.preventDefault();
          break;
        case "End":
          next = links.length - 1;
          e.preventDefault();
          break;
      }
      links[next]?.focus();
    });
  }

  window.playUi = () => {
    const audio = qs("#uiSound");
    if (!audio) return;
    audio.currentTime = 0;
    audio.play().catch(() => {});
  };
}
document.addEventListener("DOMContentLoaded", () => {
  setupThemeToggle();
  setupI18nSwitch();
});

function initIndexPage() {
  setupGalleryHero(); // –ü—Ä–µ–≤—å—é –±–æ–ª—å—à–æ–π –ø–æ—Å—Ç–µ—Ä
  setupScrollAnimations(); // –ü–ª–∞–≤–Ω—ã–π –≤—ä–µ–∑–¥ –∫–∞—Ä—Ç–æ—á–µ–∫
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º
function setupThemeToggle() {
  const btn = document.querySelector("#themeToggle");
  if (!btn) return;

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É
  const saved = localStorage.getItem("theme") || "light";
  applyTheme(saved);

  btn.addEventListener("click", () => {
    const current = document.body.classList.contains("theme-dark") ? "dark" : "light";
    const next = current === "dark" ? "light" : "dark";
    applyTheme(next);
    localStorage.setItem("theme", next);
    if (window.playUi) window.playUi();
  });

  function applyTheme(mode) {
    const isDark = mode === "dark";

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å –∫ body
    document.body.classList.toggle("theme-dark", isDark);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
    btn.setAttribute("aria-pressed", String(isDark));
    btn.innerHTML = isDark ? "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è" : "üåô –¢—ë–º–Ω–∞—è";

    // Navbar
    const navbar = document.querySelector(".navbar");
    if (navbar) {
      if (isDark) {
        navbar.classList.remove("bg-light", "navbar-light");
        navbar.classList.add("bg-dark", "navbar-dark");
      } else {
        navbar.classList.remove("bg-dark", "navbar-dark");
        navbar.classList.add("bg-light", "navbar-light");
      }
    }

    // Footer
    const footer = document.querySelector("footer");
    if (footer) {
      if (isDark) {
        footer.classList.remove("bg-light");
        footer.classList.add("bg-dark", "text-white");
      } else {
        footer.classList.remove("bg-dark", "text-white");
        footer.classList.add("bg-light");
      }
    }

    // Main content areas
    const mainElements = document.querySelectorAll("main, section");
    mainElements.forEach(el => {
      if (isDark) {
        el.classList.remove("bg-light");
        el.classList.add("bg-dark", "text-light");
      } else {
        el.classList.remove("bg-dark", "text-light");
        el.classList.add("bg-light");
      }
    });

    // Cards
    document.querySelectorAll(".card").forEach(card => {
      if (isDark) {
        card.classList.add("bg-dark", "text-light", "border-secondary");
      } else {
        card.classList.remove("bg-dark", "text-light", "border-secondary");
      }
    });

    // Forms
    document.querySelectorAll(".form-control, .form-select").forEach(input => {
      if (isDark) {
        input.classList.add("bg-dark", "text-light", "border-secondary");
        input.style.color = "#fff";
      } else {
        input.classList.remove("bg-dark", "text-light", "border-secondary");
        input.style.color = "";
      }
    });

    // Buttons
    document.querySelectorAll(".btn-primary, .btn-outline-primary").forEach(button => {
      if (isDark) {
        button.classList.add("btn-outline-light");
        button.classList.remove("btn-primary", "btn-outline-primary");
      } else {
        button.classList.remove("btn-outline-light");
        if (button.textContent.includes("–ß–∏—Ç–∞—Ç—å") || button.textContent.includes("–û—Ç–ø—Ä–∞–≤–∏—Ç—å")) {
          button.classList.add("btn-primary");
        } else {
          button.classList.add("btn-outline-primary");
        }
      }
    });

    // Contact form section
    const contactForm = document.querySelector(".contact-form");
    if (contactForm) {
      if (isDark) {
        contactForm.classList.add("bg-dark", "text-light");
      } else {
        contactForm.classList.remove("bg-dark", "text-light");
      }
    }

    // Review cards
    document.querySelectorAll(".review-card").forEach(card => {
      if (isDark) {
        card.classList.add("bg-dark", "text-light", "border-secondary");
        card.style.backgroundColor = "#2b2b2b";
      } else {
        card.classList.remove("bg-dark", "text-light", "border-secondary");
        card.style.backgroundColor = "";
      }
    });

    // Accordion items
    document.querySelectorAll(".accordion-vjs .item").forEach(item => {
      const content = item.querySelector(".content");
      if (content) {
        if (isDark) {
          content.classList.add("bg-dark", "text-light");
        } else {
          content.classList.remove("bg-dark", "text-light");
        }
      }
    });

    // Overlay and popup
    const popup = document.querySelector(".popup");
    if (popup) {
      if (isDark) {
        popup.classList.add("bg-dark", "text-light");
        popup.style.backgroundColor = "#2b2b2b";
      } else {
        popup.classList.remove("bg-dark", "text-light");
        popup.style.backgroundColor = "";
      }
    }

    // Body background
    if (isDark) {
      document.body.style.backgroundColor = "#1a1a1a";
      document.body.style.color = "#e0e0e0";
    } else {
      document.body.style.backgroundColor = "";
      document.body.style.color = "";
    }

    // Containers
    document.querySelectorAll(".container").forEach(container => {
      if (isDark) {
        container.style.color = "#e0e0e0";
      } else {
        container.style.color = "";
      }
    });

    // Text elements
    document.querySelectorAll("h1, h2, h3, h4, h5, h6, p, label").forEach(el => {
      if (isDark && !el.closest(".card, .navbar, footer")) {
        el.style.color = "#e0e0e0";
      } else if (!isDark) {
        el.style.color = "";
      }
    });
  }
}



function setupI18nSwitch() {
  const select = qs("#langSelect");
  if (!select) return;

  // –¢–µ–∫—Å—Ç—ã –¥–ª—è RU/EN/KZ
  const I18N = {
    ru: {
      "i18n-whatIsTitle": "–ß—Ç–æ —Ç–∞–∫–æ–µ MangaLib?",
      "i18n-whatIsSubtitle": "MangaLib ‚Äî —ç—Ç–æ –≤–∞—à–∞ –æ–Ω–ª–∞–π–Ω-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–∞–Ω–≥–∏.",
      "i18n-whyTitle": "–ü–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç MangaLib?",
      "i18n-card1Title": "–ë–æ–ª—å—à–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è",
      "i18n-card1Text":
        "–î–æ—Å—Ç—É–ø –∫ —Å–æ—Ç–Ω—è–º –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏ —Ä–µ–¥–∫–∏—Ö –º–∞–Ω–≥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–∞—Ö.",
      "i18n-card1Cta": "–ü–µ—Ä–µ–π—Ç–∏",
      "i18n-card2Title": "–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è",
      "i18n-card2Text":
        "–ù–æ–≤—ã–µ –≥–ª–∞–≤—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é ‚Äî —Å–ª–µ–¥–∏ –∑–∞ –ª—é–±–∏–º—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—è–º–∏.",
      "i18n-card2Cta": "–ß–∏—Ç–∞—Ç—å",
      "i18n-card3Title": "–ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ",
      "i18n-card3Text":
        "–û–±—Å—É–∂–¥–∞–π –º–∞–Ω–≥—É —Å –¥—Ä—É–≥–∏–º–∏ —á–∏—Ç–∞—Ç–µ–ª—è–º–∏ –∏ –æ—Å—Ç–∞–≤–ª—è–π —Å–≤–æ–∏ –æ—Ç–∑—ã–≤—ã.",
      "i18n-card3Cta": "–û—Ç–∑—ã–≤—ã",
    },
    en: {
      "i18n-whatIsTitle": "What is MangaLib?",
      "i18n-whatIsSubtitle": "MangaLib is your online manga library.",
      "i18n-whyTitle": "Why choose MangaLib?",
      "i18n-card1Title": "Large collection",
      "i18n-card1Text":
        "Access hundreds of popular and rare manga in Russian and English.",
      "i18n-card1Cta": "Explore",
      "i18n-card2Title": "Regular updates",
      "i18n-card2Text":
        "New chapters every week ‚Äî follow your favorite stories.",
      "i18n-card2Cta": "Read",
      "i18n-card3Title": "Active community",
      "i18n-card3Text": "Discuss manga with readers and leave your reviews.",
      "i18n-card3Cta": "Reviews",
    },
    kz: {
      "i18n-whatIsTitle": "MangaLib –¥–µ–≥–µ–Ω –Ω–µ?",
      "i18n-whatIsSubtitle": "MangaLib ‚Äî —Å—ñ–∑–¥—ñ“£ –æ–Ω–ª–∞–π–Ω –º–∞–Ω–≥–∞ –∫—ñ—Ç–∞–ø—Ö–∞–Ω–∞“£—ã–∑.",
      "i18n-whyTitle": "–ù–µ–≥–µ MangaLib?",
      "i18n-card1Title": "“Æ–ª–∫–µ–Ω –∂–∏–Ω–∞“õ",
      "i18n-card1Text":
        "–¢–∞–Ω—ã–º–∞–ª –∂”ô–Ω–µ —Å–∏—Ä–µ–∫ –º–∞–Ω–¥–∞—Ä—ã–Ω—ã“£ –∂“Ø–∑–¥–µ–≥–µ–Ω—ñ–Ω–µ “õ–æ–ª–∂–µ—Ç–∫—ñ–∑—É (“õ–∞–∑–∞“õ/–æ—Ä—ã—Å/–∞“ì—ã–ª.).",
      "i18n-card1Cta": "–ê—à—É",
      "i18n-card2Title": "–ñ–∏—ñ –∂–∞“£–∞—Ä—Ç—É",
      "i18n-card2Text": "–ñ–∞“£–∞ —Ç–∞—Ä–∞—É–ª–∞—Ä ”ô—Ä –∞–ø—Ç–∞–¥–∞ ‚Äî —Å“Ø–π—ñ–∫—Ç—ñ ”ô“£–≥—ñ–º–µ–Ω—ñ –±–∞“õ—ã–ª–∞“£—ã–∑.",
      "i18n-card2Cta": "–û“õ—É",
      "i18n-card3Title": "–ë–µ–ª—Å–µ–Ω–¥—ñ “õ–∞—É—ã–º–¥–∞—Å—Ç—ã“õ",
      "i18n-card3Text": "–û“õ—ã—Ä–º–∞–Ω–¥–∞—Ä–º–µ–Ω —Ç–∞–ª“õ—ã–ª–∞–ø, –ø—ñ–∫—ñ—Ä “õ–∞–ª–¥—ã—Ä—ã“£—ã–∑.",
      "i18n-card3Cta": "–ü—ñ–∫—ñ—Ä–ª–µ—Ä",
    },
  };

  const saved = localStorage.getItem("lang") || "ru";
  select.value = saved;
  applyLanguage(saved);

  on(select, "change", () => {
    const lang = select.value;
    switch (lang) {
      case "ru":
      case "en":
      case "kz":
        localStorage.setItem("lang", lang);
        applyLanguage(lang);
        playUi();
        break;
      default:
        localStorage.setItem("lang", "ru");
        applyLanguage("ru");
        break;
    }
  });

  function applyLanguage(lang) {
    const map = I18N[lang] || I18N.ru;
    for (const id in map) {
      const node = document.getElementById(id);
      if (node) node.textContent = map[id];
    }
  }
}

function setupGalleryHero() {
  const hero = qs("#heroImage");
  const container = hero?.closest("section") || document;
  if (!hero) return;

  on(container, "click", (e) => {
    const img = e.target.closest("img.thumb");
    if (!img) return;

    const full = img.dataset.full || img.src;
    hero.src = full;

    // –Ω–µ–±–æ–ª—å—à–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ –∑–∞–º–µ–Ω–µ
    hero.style.transition = "transform 200ms ease";
    hero.style.transform = "scale(0.98)";
    setTimeout(() => (hero.style.transform = "scale(1)"), 0);

    playUi();
  });
}
